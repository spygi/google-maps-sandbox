<!DOCTYPE html>
<html>
<head>
    <title>Trip</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
        /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #overlay {
            position: absolute;
            top: 0px;
            left: 50px;
            width: 90%;
        }

        .next-pic-button {
            position: absolute;
            top: 50%;
            height: 100px;
            cursor: pointer;
            margin: 0 10px;
        }

        img {
            image-orientation: from-image;
        }
    </style>
</head>
<body>

<div id="map"></div>
<div id="overlay"></div>

<script>
    var initialZoom = 4;
    var currentZoom;

    var markersForInitialZoom = [];
    var markersForZoomedIn = [];

    var locations = {
        "Auckland": {
            lat: -36.8485, 
            lng: 174.7633,
            pictures: [0, 1, 2,3,4,5,6,7]
        },
        "Coromandel": {
            lat: -36.864500,
            lng: 175.436250,
            pictures: [9],
            onlyForZoomedIn: true
        },
         "Whitianga": {
            lat: -36.842489, 
            lng: 175.673252,
            pictures: [10],
            onlyForZoomedIn: true
        },
        "Cathedral": {
            lat: -36.827644, 
            lng: 175.789369,
            pictures: [11,12,13,14]
        },
         "HotWater": {
            lat: -36.887075, 
            lng: 175.823464,
            pictures: [15],
            onlyForZoomedIn: true
        },
        "Waitomo": {
            lat: -38.248290, 
            lng: 175.122499,
            pictures: [19,20,21]
        },
        "BlueSpring": {
            lat: -38.036505, 
            lng: 175.834934,
            pictures: [22,23]
        },
        "Waiotapu": {
            lat: -38.358433, 
            lng: 176.368995,
            pictures: [24,25,26,27,28]
        },
         "Taupo": {
            lat: -38.660049, 
            lng: 175.962817,
            pictures: [29,30],
            onlyForZoomedIn: true
        },
        "Wellington": {
            lat: -41.206585, 
            lng: 174.793432,
            pictures: [33,34,35]
        },
        "Punakaiki": {
            lat: -42.095359, 
            lng: 171.338952,
            pictures: [36,37]
        }, 
        "Franz": {
            lat: -43.396086, 
            lng: 170.168488,
            pictures: [38,39,40,41]
        }, 
        "Wanaka": {
            lat: -44.712512, 
            lng: 169.142621,
            pictures: [42,43,44,45,46]
        },
        "Cook": {
            lat: -43.600506,  
            lng: 170.135651,
            pictures: [47,48]
        },
        "Milford": {
            lat: -44.662710, 
            lng: 167.942180,
            pictures: [49,50,51]
        },
        "Qtown": {
            lat: -45.019505, 
            lng: 168.680868,
            pictures: [52,53]
        },
        "Paihia": {
            lat: -35.284218, 
            lng: 174.060699,
            pictures: [54,55,56,57,58,59,60,61]
        },
        "Sydney": {
            lat: -33.866174, 
            lng: 150.808343,
            pictures: [62,63,64,65,66,67,68,69]
        },
        "Morisset": {
            lat: -33.132999,  
            lng: 151.516042,
            pictures: [70,71,72]
        },
        "Byron": {
            lat: -28.652136,   
            lng: 153.584528,
            pictures: [73,74,75,76,77,78]
        },
         "GoldCoast": {
            lat: -28.007850, 
            lng: 153.407274,
            pictures: [79,80],
            onlyForZoomedIn: true
        },
        "Brisbane": {
            lat: -27.481811,    
            lng: 153.004144,
            pictures: [81,"801.jpg", "802.jpg"]
        },
        "Noosa": {
            lat: -26.362500,     
            lng: 152.980593,
            pictures: [82,"803.jpg"]
        },
        "Whitsundays": {
            lat: -20.320127,      
            lng: 148.721157,
            pictures: [83,84,"804.jpg"]
        },
        "Magnetic": {
            lat: -19.146251,       
            lng: 146.829325,
            pictures: [85]
        },
        "Melbourne": {
            lat: -37.831142,        
            lng: 144.935418,
            pictures: [86,87,88,89,90,91]
        }
    };

    var map;

    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            zoom: initialZoom,
            center: {lat: -31.5, lng: 151.5}
        });

        currentZoom = initialZoom;
        createMarkersAndAttachPictures();

        map.addListener("zoom_changed", function() {
            if (map.getZoom() > initialZoom) {
                // display more markers
                for (var i = 0; i < markersForZoomedIn.length ; i++) {
                    markersForZoomedIn[i].setMap(map);
                }
            } else if (map.getZoom() <= initialZoom && currentZoom > initialZoom) {
                // remove markers
                for (var i = 0; i < markersForZoomedIn.length ; i++) {
                    markersForZoomedIn[i].setMap(null);
                }
            }

            // update currentZoom for the next zoom change
            currentZoom = map.getZoom();
        });
    }
    
    function createMarkersAndAttachPictures() {
        for (var locationKey in locations) {
            if (locations.hasOwnProperty(locationKey)) {
                var location = locations[locationKey];

                // create marker
                var marker = new google.maps.Marker;
                if (!location.onlyForZoomedIn) {
                    marker.setMap(map);
                    markersForInitialZoom.push(marker);
                } else {
                    markersForZoomedIn.push(marker);
                }

                marker.setPosition({lat: location.lat, lng: location.lng});

                // attach pictures
                var locationPictures = document.createElement("div"); 
                var img = document.createElement("img");
                var srcString; 
                img.src = "photos/" + location.pictures[0]; // display the first pic - there is always at least 1 pic
                img.setAttribute("height", "250px");
                img.setAttribute("data-id", 0);
                img.onclick = growPic;

                img.setAttribute("data-imageslocations", location.pictures);
                locationPictures.appendChild(img);

                var next = document.createElement("span");
                next.textContent = ">>>";
                next.setAttribute("data-currentid", 0);
                next.className = "next-pic-button"
                next.setAttribute("data-location", locationKey);

                if (locations[locationKey].pictures.length > 1) {
                    next.onclick = changePic; 
                    locationPictures.appendChild(next);        
                } // else nothing to cycle through

                var infoWindow = new google.maps.InfoWindow({
                    content: locationPictures
                });

                (function (_marker, _infoWindow) {
                    // we need to use a closure here due to the asynchronous callback
                    _marker.addListener('click', function() {
                        _infoWindow.open(map, _marker);
                    });
                })(marker, infoWindow);
            }
        }
    }

    function growPic (event) {
        var cloneContainer = this.parentNode.cloneNode(true); 
        document.getElementById("map").style.opacity = 0.1;
        document.getElementById("overlay").appendChild(cloneContainer); // instead of a clone we could appendChild of the original node but then on closing the overlay we would need to put it back into place

        cloneContainer.firstChild.setAttribute("height", "800px");
        // because we did a deep clone we need to re-attach a click handler
        if (cloneContainer.firstChild.dataset.imageslocations.split(",").length > 1) {
            cloneContainer.firstChild.nextSibling.onclick = changePic;       
        }
        window.addEventListener("keydown", function (event) {
            if (event.key === "Escape") {
                document.getElementById("map").style.opacity = 1;
                document.getElementById("overlay").removeChild(document.getElementById("overlay").firstChild);
            }
        }, {once: true});
    }

    function changePic(event){
        var currentPic = parseInt(this.dataset.currentid, 10);
        var next = (currentPic + 1) % this.previousSibling.dataset.imageslocations.split(",").length;

        // "hide" the current picture and show the next by changing the src attribute
        var picToShow = "photos/" + this.previousSibling.dataset.imageslocations.split(",")[next];
        this.previousSibling.src = picToShow;
        this.previousSibling.setAttribute("data-id", next);

        // update the data attribute
        this.setAttribute("data-currentid", next); 
    }
</script>

<!-- Replace the value of the locationKey parameter with your own API locationKey. -->
<script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBlMpJ4LrF2y0VWSR1qbGwfEjoSomfY_dI&callback=initMap">
</script>

</body>
</html>